<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高速道路ラジオ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; background: #eee; }
        #map { height: 40vh; width: 100%; }
        .container { padding: 20px; background: white; border-radius: 20px 20px 0 0; margin-top: -20px; position: relative; z-index: 999; min-height: 60vh; }
        #news-box { 
            text-align: left; background: #f9f9f9; padding: 15px; border: 1px solid #ddd; 
            height: 150px; overflow-y: scroll; margin-bottom: 20px; font-size: 0.9rem;
        }
        button { 
            width: 100%; padding: 15px; font-size: 1.2rem; font-weight: bold; 
            color: white; background: #007bff; border: none; border-radius: 50px; margin-bottom: 20px;
        }
        .status { color: #007bff; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="container">
        <div class="status" id="status">待機中</div>
        <div id="news-box">ここにニュースが表示されます</div>
        <button onclick="playRadio()" id="btn">受信開始</button>
    </div>

    <script>
        // 地図
        var map = L.map('map').setView([35.68, 139.75], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const synth = window.speechSynthesis;

        async function playRadio() {
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            const box = document.getElementById('news-box');

            // ★ここが重要！ボタンを押した瞬間に「無音」を再生して、iPhoneの音声機能を起こす
            synth.cancel();
            const wakeUp = new SpeechSynthesisUtterance('');
            synth.speak(wakeUp);

            btn.disabled = true;
            btn.style.background = "#ccc";
            status.innerText = "データを読み込んでいます...";

            try {
                // キャッシュ対策をしてデータを取得
                const res = await fetch('traffic.json?' + Date.now());
                if (!res.ok) throw new Error("データがありません");
                
                const data = await res.json();
                
                // 画面に表示
                box.innerHTML = data.join('<hr>');
                status.innerText = "再生中";

                // 全部つなげて読む
                const text = data.join("。");
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'ja-JP';
                
                utter.onend = () => {
                    status.innerText = "再生終了";
                    btn.disabled = false;
                    btn.style.background = "#007bff";
                };
                
                // データを読み終わったら再生開始
                synth.speak(utter);

            } catch (e) {
                status.innerText = "エラー";
                box.innerText = "情報の取得に失敗しました。Actionsが動いているか確認してください。";
                btn.disabled = false;
                btn.style.background = "#007bff";
                // エラーメッセージを喋らせる
                const errUtter = new SpeechSynthesisUtterance("情報の取得に失敗しました");
                synth.speak(errUtter);
            }
        }
    </script>
</body>
</html>
