<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム交通ラジオ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; background-color: #f4f4f4; }
        #map { height: 40vh; width: 100%; z-index: 1; }
        .controls { 
            padding: 20px; background-color: white; border-radius: 20px 20px 0 0; 
            margin-top: -20px; position: relative; z-index: 2; min-height: 60vh; 
        }
        
        /* ニュースリストの表示エリア */
        #news-list {
            text-align: left;
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px auto;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #333;
        }
        .news-item { border-bottom: 1px solid #eee; padding: 5px 0; }
        .news-item:last-child { border-bottom: none; }

        button {
            font-size: 1.2rem; padding: 15px; margin: 10px 0;
            border: none; border-radius: 50px; cursor: pointer; width: 100%;
            color: white; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #btn-play { background-color: #007bff; }
        #btn-stop { background-color: #dc3545; display: none; }
        .status-bar { font-weight: bold; color: #007bff; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="controls">
        <div class="status-bar" id="status-text">待機中</div>
        
        <div id="news-list">ここに交通情報が表示されます...</div>

        <button id="btn-play" onclick="startRadio()">受信開始</button>
        <button id="btn-stop" onclick="stopRadio()">停止</button>
    </div>

    <script>
        // 1. 地図設定
        var map = L.map('map').setView([35.685, 139.752], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // 2. 音声設定
        const synth = window.speechSynthesis;
        let trafficData = [];

        async function fetchTrafficData() {
            document.getElementById('status-text').innerText = "データを取得中...";
            try {
                const res = await fetch('traffic.json?' + new Date().getTime());
                if (res.ok) {
                    trafficData = await res.json();
                    displayNews(trafficData); // 画面に文字を出す
                    document.getElementById('status-text').innerText = "データ取得完了";
                    return true;
                }
            } catch (e) {
                console.error(e);
                trafficData = ["情報の取得に失敗しました。"];
                displayNews(trafficData);
            }
            return false;
        }

        // 画面にニュースをリスト表示する関数
        function displayNews(data) {
            const list = document.getElementById('news-list');
            list.innerHTML = ""; // クリア
            data.forEach(line => {
                const div = document.createElement('div');
                div.className = 'news-item';
                div.innerText = line;
                list.appendChild(div);
            });
        }

        async function startRadio() {
            await fetchTrafficData();

            // ボタン切り替え
            document.getElementById('btn-play').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'inline-block';
            document.getElementById('status-text').innerText = "再生中...";

            // ★ここが修正点：全部つなげて一気に喋らせる（途切れ対策）
            const fullText = trafficData.join("。 "); // 句点をつなぐ
            const utterance = new SpeechSynthesisUtterance(fullText);
            utterance.lang = 'ja-JP';
            utterance.rate = 1.0;

            // 読み終わったらボタンを戻す
            utterance.onend = function() {
                document.getElementById('status-text').innerText = "再生終了";
                document.getElementById('btn-play').style.display = 'inline-block';
                document.getElementById('btn-stop').style.display = 'none';
            };

            synth.cancel(); // おまじない
            synth.speak(utterance);
        }

        function stopRadio() {
            synth.cancel();
            document.getElementById('btn-play').style.display = 'inline-block';
            document.getElementById('btn-stop').style.display = 'none';
            document.getElementById('status-text').innerText = "停止";
        }
    </script>
</body>
</html>
