<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äº¤é€šãƒ©ã‚¸ã‚ª</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 0;
            margin: 0;
            background-color: #f0f0f0;
        }
        h1 { font-size: 1.2rem; margin: 10px; }
        
        /* åœ°å›³ã®è¦‹ãŸç›®è¨­å®š */
        #map {
            height: 45vh; /* ç”»é¢ã®åŠåˆ†ã®é«˜ã• */
            width: 100%;
            z-index: 1;
        }

        .controls { 
            padding: 20px; 
            background-color: white;
            border-radius: 20px 20px 0 0;
            margin-top: -20px;
            position: relative;
            z-index: 2;
            min-height: 50vh;
        }
        
        .status {
            margin: 10px auto;
            padding: 15px;
            background: #e6f7ff;
            border-radius: 10px;
            font-weight: bold;
            width: 90%;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            line-height: 1.5;
        }

        button {
            font-size: 1.2rem;
            padding: 15px 30px;
            margin: 15px 5px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 80%;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #btn-play { background-color: #007bff; }
        #btn-stop { background-color: #dc3545; display: none; }
        
        .timestamp {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h1>ğŸš— ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äº¤é€šãƒ©ã‚¸ã‚ª</h1>
    
    <div id="map"></div>

    <div class="controls">
        <div class="status" id="status-text">å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦<br>æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„</div>
        <div class="timestamp" id="data-time"></div>
        <button id="btn-play" onclick="startRadio()">å—ä¿¡é–‹å§‹</button>
        <button id="btn-stop" onclick="stopRadio()">åœæ­¢</button>
        
        <p style="font-size: 0.8rem; color: #666; margin-top: 20px;">
            â€» 15ã€œ20åˆ†ãŠãã«è‡ªå‹•æ›´æ–°ã•ã‚ŒãŸ<br>æœ€æ–°ã®æ¸‹æ»æƒ…å ±ã‚’èª­ã¿ä¸Šã’ã¾ã™ã€‚
        </p>
    </div>

    <script>
        // ==========================================
        // 1. åœ°å›³ã®è¨­å®šï¼ˆè¦‹ãŸç›®éƒ¨åˆ†ï¼‰
        // ==========================================
        
        // æ±äº¬ã‚’ä¸­å¿ƒ(ç·¯åº¦35.68, çµŒåº¦139.75)ã«è¡¨ç¤º
        var map = L.map('map').setView([35.685, 139.752], 11);

        // åœ°å›³ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // æ¸‹æ»ãƒ©ã‚¤ãƒ³ã‚’æãé–¢æ•°
        function drawTraffic(coords, color, description) {
            L.polyline(coords, {color: color, weight: 6, opacity: 0.7}).addTo(map);
            if(description) {
                 L.marker(coords[0]).addTo(map).bindPopup(description);
            }
        }

        // â˜…ã‚µãƒ³ãƒ—ãƒ«ã®ç·šï¼ˆâ€»ã“ã“ã¯ã¾ã ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£å‹•ã§ã¯ãªãã€å›ºå®šè¡¨ç¤ºã§ã™ï¼‰
        var c1Route = [[35.69, 139.77],[35.68, 139.77],[35.67, 139.76],[35.66, 139.74],[35.69, 139.75]];
        drawTraffic(c1Route, 'red', 'é¦–éƒ½é«˜ï¼šæ··é›‘ã‚¨ãƒªã‚¢ï¼ˆç›®å®‰ï¼‰');
        
        var tomeiRoute = [[35.65, 139.69],[35.62, 139.62],[35.59, 139.56]];
        drawTraffic(tomeiRoute, 'green', 'æ±åãƒ»3å·ç·šæ–¹é¢ï¼ˆç›®å®‰ï¼‰');


        // ==========================================
        // 2. èª­ã¿ä¸Šã’ï¼†ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½
        // ==========================================
        
        let isPlaying = false;
        const synth = window.speechSynthesis;
        let trafficData = [];

        // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function fetchTrafficData() {
            try {
                document.getElementById('status-text').innerText = "æœ€æ–°æƒ…å ±ã‚’å•ã„åˆã‚ã›ä¸­...";
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’èª­ã¿è¾¼ã¾ãªã„ã‚ˆã†ã€æ™‚åˆ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã¤ã‘ã‚‹
                const res = await fetch('traffic.json?' + new Date().getTime());
                
                if (res.ok) {
                    trafficData = await res.json();
                    document.getElementById('status-text').innerText = "æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚èª­ã¿ä¸Šã’ã‚’é–‹å§‹ã—ã¾ã™ã€‚";
                    document.getElementById('data-time').innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—: " + new Date().toLocaleTimeString();
                    return true;
                } else {
                    throw new Error("File not found");
                }
            } catch (e) {
                console.error(e);
                // ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
                trafficData = [
                    "ç¾åœ¨ã€äº¤é€šæƒ…å ±ã‚’åé›†ä¸­ã§ã™ã€‚",
                    "ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒä½œæˆã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚",
                    "GitHub Actionsã®å®Ÿè¡Œå±¥æ­´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                ];
                document.getElementById('status-text').innerText = "æº–å‚™ä¸­...";
                return false;
            }
        }

        // å†ç”Ÿãƒœã‚¿ãƒ³
        async function startRadio() {
            if (isPlaying) return;
            
            // ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã‚‹
            await fetchTrafficData();

            isPlaying = true;
            synth.cancel(); // ãƒªã‚»ãƒƒãƒˆ
            
            // ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('btn-play').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'inline-block';
            
            // èª­ã¿ä¸Šã’ãƒ«ãƒ¼ãƒ—é–‹å§‹
            speakAll(0);
        }

        // åœæ­¢ãƒœã‚¿ãƒ³
        function stopRadio() {
            isPlaying = false;
            synth.cancel();
            document.getElementById('btn-play').style.display = 'inline-block';
            document.getElementById('btn-stop').style.display = 'none';
            document.getElementById('status-text').innerText = "åœæ­¢ä¸­";
        }

        // å†å¸°çš„ã«ãƒªã‚¹ãƒˆã‚’èª­ã¿ä¸Šã’ã‚‹é–¢æ•°
        function speakAll(index) {
            if (!isPlaying) return;

            // æœ€å¾Œã¾ã§èª­ã‚“ã ã‚‰æœ€åˆã«æˆ»ã‚‹
            if (index >= trafficData.length) {
                index = 0;
                // 1å‘¨ã—ãŸã‚‰å°‘ã—ä¼‘æ†©(3ç§’)
                setTimeout(() => speakAll(0), 3000);
                return;
            }

            const text = trafficData[index];
            
            // ç”»é¢ã®æ–‡å­—æ›´æ–°
            document.getElementById('status-text').innerText = text;

            // èª­ã¿ä¸Šã’è¨­å®š
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 1.0; // é€Ÿåº¦
            
            // èª­ã¿çµ‚ã‚ã£ãŸã‚‰æ¬¡ã¸
            utterance.onend = function() {
                if(isPlaying) {
                    speakAll(index + 1);
                }
            };
            
            // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚æ¬¡ã¸é€²ã‚€
            utterance.onerror = function() {
                if(isPlaying) {
                    setTimeout(() => speakAll(index + 1), 1000);
                }
            };

            synth.speak(utterance);
        }
    </script>
</body>
</html>
